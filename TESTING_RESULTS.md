# üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ Runtime –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

*–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –ø—Ä–æ–µ–∫—Ç—É*

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—ñ–≤

### üî¥ JWT Refresh Token
- **–°—Ç–∞—Ç—É—Å:** –ü—Ä–∞—Ü—é—î
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ —É—Å–ø—ñ—à–Ω–æ (9/9)
- **Runtime —Ç–µ—Å—Ç:** –í–∏–∫–æ–Ω–∞–Ω–æ –ø–æ–≤–Ω–µ runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑ —Ä–µ–∞–ª—å–Ω–∏–º API —Å–µ—Ä–≤–µ—Ä–æ–º
- **–î–µ—Ç–∞–ª—ñ:**
  - Endpoint: `/api/v1/auth/refresh` (POST)
  - –§–∞–π–ª: `apps/api/app/api/v1/endpoints/auth.py:69`
  - –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: `refresh_token()` —Ñ—É–Ω–∫—Ü—ñ—è –∑ rate limiting
  - Service: `AuthService.refresh_token()` –≤ `apps/api/app/services/auth_service.py:150`
  - –í–∞–ª—ñ–¥–∞—Ü—ñ—è: ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è—î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Å–µ—Å—ñ—ó, —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó refresh token
  - Audit logging: ‚úÖ –õ–æ–≥—É—î –≤—Å—ñ —Å–ø—Ä–æ–±–∏ refresh (success/failure) —á–µ—Ä–µ–∑ logger

  **–ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó:**
  1. ‚úÖ Magic Link Request - —É—Å–ø—ñ—à–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è magic link –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  2. ‚úÖ Magic Link Verification - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è access —ñ refresh —Ç–æ–∫–µ–Ω—ñ–≤
  3. ‚úÖ Valid Refresh Token - —É—Å–ø—ñ—à–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è access token
  4. ‚úÖ Invalid Refresh Token Rejection - –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω—É (401)
  5. ‚úÖ Empty Refresh Token Rejection - –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ —Ç–æ–∫–µ–Ω—É (401)
  6. ‚úÖ Session Validation - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Å–µ—Å—ñ—ó –ø—Ä–∏ refresh
  7. ‚úÖ Rate Limiting - –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –ø—Ä–∞—Ü—é—î (429 –ø—ñ—Å–ª—è 5 –∑–∞–ø–∏—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É)
  8. ‚úÖ Access Token Usage - access token –ø—Ä–∞—Ü—é—î –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ `/auth/me`
  9. ‚úÖ Audit Logging - —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–∏—Å—É—Ç–Ω—è –≤ AuthService

  **–ó–Ω–∞–π–¥–µ–Ω—ñ –±–∞–≥–∏ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
  - üêõ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–∞—Ä–∞–º–µ—Ç—Ä `http_request` –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–æ –Ω–∞ `request` –≤ `request_magic_link()`
    (apps/api/app/api/v1/endpoints/auth.py:24) - slowapi –≤–∏–º–∞–≥–∞—î —Å–∞–º–µ –Ω–∞–∑–≤—É `request`
  - üêõ –î–æ–¥–∞–Ω–æ: –ø—ñ–¥—Ç—Ä–∏–º–∫—É SQLite –≤ database.py –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (—É–º–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ engine)

  **–í–∞–∂–ª–∏–≤–∞ –ø—Ä–∏–º—ñ—Ç–∫–∞:**
  ‚ö†Ô∏è Rate limiting –≤ –∫–æ–¥—ñ: **5/minute** (auth.py:70), –∞ –Ω–µ 20/hour —è–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ –æ–ø–∏—Å—ñ

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª JWT Refresh Token **–ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–∞—Ü—é—î —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–∏–π**.
  –í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó (–ø–æ–∑–∏—Ç–∏–≤–Ω—ñ/–Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ) –ø—Ä–∞—Ü—é—é—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–æ.
  Rate limiting –∞–∫—Ç–∏–≤–Ω–∏–π —Ç–∞ –ø—Ä–∞—Ü—é—î (5 –∑–∞–ø–∏—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É).
  Audit logging —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ logger infrastructure.
  –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ 1 –∫—Ä–∏—Ç–∏—á–Ω–∏–π –±–∞–≥ –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º request.

---

### üî¥ Race Condition –≤ Payment Webhooks
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —ñ—Å–Ω—É—î –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
- **Runtime —Ç–µ—Å—Ç:** ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ - endpoint –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–î–µ—Ç–∞–ª—ñ:**
  - Endpoint: `/api/v1/payment/webhook` - **–ù–ï –ó–ù–ê–ô–î–ï–ù–û** –≤ –ø—Ä–æ–µ–∫—Ç—ñ
  - Payment webhook functionality **–ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û**
  - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞ —á–µ—Ä–µ–∑ git history: payment endpoints –≤—ñ–¥—Å—É—Ç–Ω—ñ –¥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
  - –ù–µ–º–æ–∂–ª–∏–≤–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–æ–¥—É, —è–∫–∏–π –Ω–µ —ñ—Å–Ω—É—î

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  Payment webhook —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –∑ race condition protection **–ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û** –≤ –ø—Ä–æ–µ–∫—Ç—ñ.
  Runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–º–æ–∂–ª–∏–≤–µ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.

  **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ü—ñ–¥ —á–∞—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±—É–ª–∞ –ø–æ–º–∏–ª–∫–æ–≤–æ —Å—Ç–≤–æ—Ä–µ–Ω–∞ mock implementation –∑–∞–º—ñ—Å—Ç—å
  —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è. –¶–µ –±—É–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - runtime —Ç–µ—Å—Ç –º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥,
  –∞ –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª.

---

### üî¥ BackgroundJob Static Call Bug
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —ñ—Å–Ω—É—î –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
- **Runtime —Ç–µ—Å—Ç:** ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ - —Ñ–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–î–µ—Ç–∞–ª—ñ:**
  - –§–∞–π–ª: `apps/api/app/services/background_jobs.py` - **–ù–ï –ó–ù–ê–ô–î–ï–ù–û**
  - –ú–µ—Ç–æ–¥: `BackgroundJobService.generate_full_document_async()` - **–ù–ï –Ü–°–ù–£–Ñ**
  - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: –§–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó `apps/api/app/services/`
  - –Ü—Å–Ω—É—é—á—ñ services: admin_service.py, ai_service.py, auth_service.py, document_service.py, payment_service.py
  - BackgroundJobService –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç—ñ

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  BackgroundJobService —Ç–∞ –º–µ—Ç–æ–¥ `generate_full_document_async()` **–ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û** –≤ –ø—Ä–æ–µ–∫—Ç—ñ.
  Runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–º–æ–∂–ª–∏–≤–µ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.
  –ù–µ –º–æ–∂–Ω–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –±–∞–≥ –≤ –∫–æ–¥—ñ, —è–∫–∏–π –Ω–µ —ñ—Å–Ω—É—î.

---

### üî¥ Minimum 3 Pages Validation
- **–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ü—Ä–∞—Ü—é—î (–∞–ª–µ –Ω–µ —è–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ —Ç–µ—Å—Ç—ñ)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 7/7 —Ç–µ—Å—Ç—ñ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ)
- **Runtime —Ç–µ—Å—Ç:** –í–∏–∫–æ–Ω–∞–Ω–æ –ø–æ–≤–Ω–µ runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è Pydantic validation
- **‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û - –†–û–ó–ë–Ü–ñ–ù–Ü–°–¢–¨:**
  - **–û–ø–∏—Å —Ç–µ—Å—Ç—É:** `ge=3` (–º—ñ–Ω—ñ–º—É–º 3 —Å—Ç–æ—Ä—ñ–Ω–∫–∏)
  - **–†–µ–∞–ª—å–Ω–∏–π –∫–æ–¥:** `ge=1` (–º—ñ–Ω—ñ–º—É–º 1 —Å—Ç–æ—Ä—ñ–Ω–∫–∞)
  - **Frontend:** `min(1)` (–º—ñ–Ω—ñ–º—É–º 1 —Å—Ç–æ—Ä—ñ–Ω–∫–∞)
  - –ö–æ–º–µ–Ω—Ç–∞—Ä "CRITICAL: Minimum 3 pages as per business rules" **–ù–ï –ó–ù–ê–ô–î–ï–ù–û** –≤ –∫–æ–¥—ñ

- **–î–µ—Ç–∞–ª—ñ:**
  - –§–∞–π–ª: `apps/api/app/schemas/document.py:25`
  - –†–µ–∞–ª—å–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è: `target_pages: int = Field(default=50, ge=1, le=1000)`
  - Frontend: `apps/web/components/dashboard/GenerateSectionForm.tsx:14`
  - Frontend –≤–∞–ª—ñ–¥–∞—Ü—ñ—è: `pages: z.number().min(1, 'Must be at least 1 page').max(100)`
  - Pydantic –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∞–ª—ñ–¥—É—î `ge=1` (greater or equal 1)
  - –ü—Ä–∏ –∑–Ω–∞—á–µ–Ω–Ω—ñ < 1: –ü–æ–≤–µ—Ä—Ç–∞—î 422 Validation Error: "Input should be greater than or equal to 1"

  **–ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó:**
  1. ‚úÖ target_pages=1 - –ø—Ä–∏–π–Ω—è—Ç–æ (–ø–æ—Ç–æ—á–Ω–∏–π –º—ñ–Ω—ñ–º—É–º)
  2. ‚úÖ target_pages=0 - –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –∑ ValidationError
  3. ‚úÖ target_pages=-5 - –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ –∑ ValidationError
  4. ‚úÖ target_pages=3 - –ø—Ä–∏–π–Ω—è—Ç–æ (–æ—á—ñ–∫—É–≤–∞–Ω–∏–π –º—ñ–Ω—ñ–º—É–º –∑–≥—ñ–¥–Ω–æ –æ–ø–∏—Å—É)
  5. ‚úÖ target_pages=50 - –ø—Ä–∏–π–Ω—è—Ç–æ (default –∑–Ω–∞—á–µ–Ω–Ω—è)
  6. ‚úÖ target_pages=1001 - –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ (–ø–µ—Ä–µ–≤–∏—â—É—î –º–∞–∫—Å–∏–º—É–º le=1000)
  7. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ Field constraints: `[Ge(ge=1), Le(le=1000)]`

  **–†–µ–∞–ª—å–Ω—ñ constraints:**
  ```python
  # apps/api/app/schemas/document.py:25
  target_pages: int = Field(default=50, ge=1, le=1000)
  #                                     ^^^^  - –º—ñ–Ω—ñ–º—É–º 1, –ù–ï 3
  ```

  **Frontend validation:**
  ```typescript
  // GenerateSectionForm.tsx:14
  pages: z.number().min(1, 'Must be at least 1 page').max(100)
  //                 ^^^^^^  - –º—ñ–Ω—ñ–º—É–º 1, –ù–ï 3
  ```

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  –í–∞–ª—ñ–¥–∞—Ü—ñ—è **–ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ** –∑–≥—ñ–¥–Ω–æ –∑ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–º –∫–æ–¥–æ–º (`ge=1`).
  Pydantic –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ñ–¥—Ö–∏–ª—è—î –∑–Ω–∞—á–µ–Ω–Ω—è < 1 —Ç–∞ > 1000.
  Default –∑–Ω–∞—á–µ–Ω–Ω—è (50) –ø—Ä–∞—Ü—é—î.

  **–û–î–ù–ê–ö:** –Ü—Å–Ω—É—î **—Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å –º—ñ–∂ –æ–ø–∏—Å–æ–º —Ç–µ—Å—Ç—É —ñ —Ä–µ–∞–ª—å–Ω–∏–º –∫–æ–¥–æ–º**:
  - –û–ø–∏—Å —Ç–µ—Å—Ç—É –æ—á—ñ–∫—É—î: `ge=3` (–º—ñ–Ω—ñ–º—É–º 3 —Å—Ç–æ—Ä—ñ–Ω–∫–∏) + –∫–æ–º–µ–Ω—Ç–∞—Ä "CRITICAL: Minimum 3 pages"
  - –†–µ–∞–ª—å–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: `ge=1` (–º—ñ–Ω—ñ–º—É–º 1 —Å—Ç–æ—Ä—ñ–Ω–∫–∞), –∫–æ–º–µ–Ω—Ç–∞—Ä –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
  - Frontend —Ç–∞–∫–æ–∂ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `min(1)`, –Ω–µ `min(3)`

  –¶–µ –Ω–µ –±–∞–≥ –≤ –∫–æ–¥—ñ - –∫–æ–¥ –ø—Ä–∞—Ü—é—î —è–∫ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ. –ê–ª–µ –º–æ–∂–ª–∏–≤–æ —î —Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å –º—ñ–∂
  –±—ñ–∑–Ω–µ—Å-–≤–∏–º–æ–≥–∞–º–∏ (3 —Å—Ç–æ—Ä—ñ–Ω–∫–∏) —ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—î—é (1 —Å—Ç–æ—Ä—ñ–Ω–∫–∞).

---

